From 30be8794ba6e950e1f6966de7db7eeb00fbe83e5 Mon Sep 17 00:00:00 2001
From: harishkumarbalaji <harishkumarbalaji@gmail.com>
Date: Thu, 6 Feb 2025 00:18:33 -0600
Subject: [PATCH 004/150] Fix setup machine script and add volume mounts for
 dbus

---
 run_docker_container.sh     |  2 +-
 setup/Dockerfile.cuda12     |  2 +-
 setup/docker-compose.yaml   |  5 +++++
 setup/setup_this_machine.sh | 37 ++++++++++++++++++++++++++++++-------
 4 files changed, 37 insertions(+), 9 deletions(-)

diff --git a/run_docker_container.sh b/run_docker_container.sh
index c987a901..ac0f998b 100644
--- a/run_docker_container.sh
+++ b/run_docker_container.sh
@@ -3,6 +3,6 @@
 if [ "$(docker ps -q -f name=gem_stack-container)" ]; then
     docker exec -it gem_stack-container bash
 else
-    docker compose -f setup/docker-compose.yaml up -d
+    UID=$(id -u) GID=$(id -g) docker compose -f setup/docker-compose.yaml up -d
     docker exec -it gem_stack-container bash
 fi
\ No newline at end of file
diff --git a/setup/Dockerfile.cuda12 b/setup/Dockerfile.cuda12
index ffafaaa3..32005202 100644
--- a/setup/Dockerfile.cuda12
+++ b/setup/Dockerfile.cuda12
@@ -18,7 +18,7 @@ RUN ln -fs /usr/share/zoneinfo/$TZ /etc/localtime \
     && apt-get update && apt-get install -y tzdata \
     && rm -rf /var/lib/apt/lists/*
 
-# install Zed SDK
+# install Zed SDK. If you want to install a different version, change to this https://download.stereolabs.com/zedsdk/4.2/cu12/ubuntu20
 RUN wget https://stereolabs.sfo2.cdn.digitaloceanspaces.com/zedsdk/4.2/ZED_SDK_Ubuntu20_cuda12.1_v4.2.4.zstd.run -O zed_sdk.run
 RUN chmod +x zed_sdk.run
 RUN ./zed_sdk.run -- silent
diff --git a/setup/docker-compose.yaml b/setup/docker-compose.yaml
index 8c43cfca..f0c7703b 100644
--- a/setup/docker-compose.yaml
+++ b/setup/docker-compose.yaml
@@ -22,6 +22,11 @@ services:
       - "/tmp/.X11-unix:/tmp/.X11-unix:rw"
     environment:
       - DISPLAY=${DISPLAY}
+      - XDG_RUNTIME_DIR=/tmp/runtime-${USER}
+      - DBUS_SYSTEM_BUS_ADDRESS=unix:path=/var/run/dbus/system_bus_socket
+      - DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/${UID}/bus
+      - NVIDIA_DRIVER_CAPABILITIES=all
+      - NVIDIA_VISIBLE_DEVICES=all
       # - LIBGL_ALWAYS_SOFTWARE=1 # Uncomment if you want to use software rendering (No GPU)
     network_mode: host
     ipc: host
diff --git a/setup/setup_this_machine.sh b/setup/setup_this_machine.sh
index 5c991886..36690f1d 100755
--- a/setup/setup_this_machine.sh
+++ b/setup/setup_this_machine.sh
@@ -16,17 +16,25 @@ fi
 source /opt/ros/noetic/setup.bash
 
 #install Zed SDK
-echo "Select CUDA version:"
+echo "To install the ZED SDK, select the CUDA version:"
 echo "1) CUDA 11.8"
 echo "2) CUDA 12+"
-read -p "Enter choice [1-2]: " choice
+echo "3) No GPU (Skip ZED SDK installation)"
+read -p "Enter choice [1-3]: " choice
 
 case $choice in
     1)
         wget https://download.stereolabs.com/zedsdk/4.0/cu118/ubuntu20 -O zed_sdk.run
+        chmod +x zed_sdk.run
+        ./zed_sdk.run -- silent
         ;;
     2)
         wget https://stereolabs.sfo2.cdn.digitaloceanspaces.com/zedsdk/4.2/ZED_SDK_Ubuntu20_cuda12.1_v4.2.4.zstd.run -O zed_sdk.run
+        chmod +x zed_sdk.run
+        ./zed_sdk.run -- silent
+        ;;
+    3)
+        echo "Skipping ZED SDK installation..."
         ;;
     *)
         echo "Invalid choice"
@@ -34,14 +42,12 @@ case $choice in
         ;;
 esac
 
-chmod +x zed_sdk.run
-./zed_sdk.run -- silent
-
 #create ROS Catkin workspace
 mkdir -p ~/catkin_ws/src
 
 # Store current working directory
 CURRENT_DIR=$(pwd)
+echo "CURRENT_DIR: $CURRENT_DIR"
 
 #install ROS dependencies and packages
 cd ~/catkin_ws/src
@@ -57,9 +63,26 @@ catkin_make -DCMAKE_BUILD_TYPE=Release
 source devel/setup.bash
 
 cd $CURRENT_DIR
-cd ..
 #install GEMstack Python dependencies
-python3 -m pip install -r requirements.txt
+
+# Ask the user if they want to install ultralytics
+read -p "Do you want to install ultralytics? (y/n): " install_ultralytics
+
+# Create a temporary requirements file
+temp_requirements="temp_requirements.txt"
+
+# Copy all lines except ultralytics if the user chooses to skip it
+if [ "$install_ultralytics" == "y" ]; then
+    cp requirements.txt $temp_requirements
+else
+    grep -v "ultralytics" requirements.txt > $temp_requirements
+fi
+
+# Install the packages from the temporary requirements file
+pip3 install -r $temp_requirements
+
+# Clean up the temporary file
+rm $temp_requirements
 
 #install other dependencies
 sudo apt-get install -y ros-noetic-septentrio-gnss-driver
\ No newline at end of file
-- 
2.38.1

