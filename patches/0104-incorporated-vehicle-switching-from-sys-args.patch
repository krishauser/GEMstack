From 2975c91677fda45e64e58f9fa6a1543319751b22 Mon Sep 17 00:00:00 2001
From: nvikramraj <nvikramraj1305@gmail.com>
Date: Tue, 8 Apr 2025 10:39:16 -0500
Subject: [PATCH 104/150] incorporated vehicle switching from sys args

---
 GEMstack/knowledge/defaults/__init__.py       | 35 +++++++++++++++++--
 GEMstack/knowledge/defaults/current.yaml      |  3 +-
 GEMstack/knowledge/defaults/e2.yaml           | 34 ++++++++++++++++++
 GEMstack/knowledge/defaults/e2_gazebo.yaml    | 34 ++++++++++++++++++
 GEMstack/knowledge/defaults/e4_gazebo.yaml    | 34 ++++++++++++++++++
 .../gem_e2_sensor_environment_gazebo.yaml     |  2 +-
 GEMstack/knowledge/vehicle/gem_e4_gazebo.yaml | 13 +++++++
 launch/gazebo_simulation.yaml                 |  3 +-
 main.py                                       |  2 +-
 9 files changed, 151 insertions(+), 9 deletions(-)
 create mode 100644 GEMstack/knowledge/defaults/e2.yaml
 create mode 100644 GEMstack/knowledge/defaults/e2_gazebo.yaml
 create mode 100644 GEMstack/knowledge/defaults/e4_gazebo.yaml
 create mode 100644 GEMstack/knowledge/vehicle/gem_e4_gazebo.yaml

diff --git a/GEMstack/knowledge/defaults/__init__.py b/GEMstack/knowledge/defaults/__init__.py
index ee5354a7..f7126e6a 100644
--- a/GEMstack/knowledge/defaults/__init__.py
+++ b/GEMstack/knowledge/defaults/__init__.py
@@ -1,7 +1,36 @@
 from ...utils.config import load_config_recursive
-import os
-SETTINGS_FILE = os.path.join(os.path.split(__file__)[0],'current.yaml')
+import os,sys
+
+
+# Identify the vehicle used and load settings else default to vehicle config at current.yaml'
+# default currently uses GEM e4
+vehicle = "default"
+
+for arg in sys.argv:
+    if arg.startswith('--'):
+        k,v = arg.split('=',1)
+        k = k[2:]
+        v = v.strip('"')
+        if k == "vehicle":
+            vehicle = v
+            sys.argv.remove(arg)
+            break
+
+if(vehicle == 'e2'):
+    vehicle_config = 'e2.yaml'
+elif(vehicle == 'e4'):
+    vehicle_config = 'current.yaml'
+elif(vehicle == 'e2_gazebo'):
+    vehicle_config = 'e2_gazebo.yaml'
+elif(vehicle == 'e4_gazebo'):
+    vehicle_config = 'e4_gazebo.yaml'
+else:
+    print("Unknown vehicle argument passed")
+    vehicle = "default"
+    vehicle_config = 'current.yaml'
+
+SETTINGS_FILE = os.path.join(os.path.split(__file__)[0],vehicle_config)
 print("**************************************************************")
-print("Loading default settings from",SETTINGS_FILE)
+print(f"Loading {vehicle} settings from",SETTINGS_FILE)
 print("**************************************************************")
 SETTINGS = load_config_recursive(SETTINGS_FILE)
diff --git a/GEMstack/knowledge/defaults/current.yaml b/GEMstack/knowledge/defaults/current.yaml
index 645395d4..c886288b 100644
--- a/GEMstack/knowledge/defaults/current.yaml
+++ b/GEMstack/knowledge/defaults/current.yaml
@@ -1,8 +1,7 @@
 # ********* Main settings entry point for behavior stack ***********
 
 # Configure settings for the vehicle / vehicle model
-# vehicle:  !include ../vehicle/gem_e4.yaml
-vehicle:  !include ../vehicle/gem_e2_gazebo.yaml
+vehicle:  !include ../vehicle/gem_e4.yaml
 
 #arguments for algorithm components here
 model_predictive_controller:
diff --git a/GEMstack/knowledge/defaults/e2.yaml b/GEMstack/knowledge/defaults/e2.yaml
new file mode 100644
index 00000000..ed8d26d1
--- /dev/null
+++ b/GEMstack/knowledge/defaults/e2.yaml
@@ -0,0 +1,34 @@
+# ********* Main settings entry point for behavior stack ***********
+
+# Configure settings for the vehicle / vehicle model
+vehicle:  !include ../vehicle/gem_e2.yaml
+
+#arguments for algorithm components here
+model_predictive_controller:
+    dt: 0.1
+    lookahead: 20
+control:
+    recovery:
+        brake_amount : 0.5
+        brake_speed : 2.0
+    pure_pursuit:
+        lookahead: 2.0
+        lookahead_scale: 3.0
+        crosstrack_gain: 1.0
+        desired_speed: trajectory
+    longitudinal_control:
+        pid_p: 1.0
+        pid_i: 0.1
+        pid_d: 0.0
+
+#configure the simulator, if using
+simulator:
+    dt: 0.01
+    real_time_multiplier: 1.0    # make the simulator run faster than real time by making this > 1
+    gnss_emulator: 
+        dt: 0.1    #10Hz
+        #position_noise: 0.1  #10cm noise
+        #orientation_noise: 0.04  #2.3 degrees noise
+        #velocity_noise:
+        #    constant: 0.04  #4cm/s noise
+        #    linear: 0.02    #2% noise
\ No newline at end of file
diff --git a/GEMstack/knowledge/defaults/e2_gazebo.yaml b/GEMstack/knowledge/defaults/e2_gazebo.yaml
new file mode 100644
index 00000000..aebc4c9d
--- /dev/null
+++ b/GEMstack/knowledge/defaults/e2_gazebo.yaml
@@ -0,0 +1,34 @@
+# ********* Main settings entry point for behavior stack ***********
+
+# Configure settings for the vehicle / vehicle model
+vehicle:  !include ../vehicle/gem_e2_gazebo.yaml
+
+#arguments for algorithm components here
+model_predictive_controller:
+    dt: 0.1
+    lookahead: 20
+control:
+    recovery:
+        brake_amount : 0.5
+        brake_speed : 2.0
+    pure_pursuit:
+        lookahead: 2.0
+        lookahead_scale: 3.0
+        crosstrack_gain: 1.0
+        desired_speed: trajectory
+    longitudinal_control:
+        pid_p: 1.0
+        pid_i: 0.1
+        pid_d: 0.0
+
+#configure the simulator, if using
+simulator:
+    dt: 0.01
+    real_time_multiplier: 1.0    # make the simulator run faster than real time by making this > 1
+    gnss_emulator: 
+        dt: 0.1    #10Hz
+        #position_noise: 0.1  #10cm noise
+        #orientation_noise: 0.04  #2.3 degrees noise
+        #velocity_noise:
+        #    constant: 0.04  #4cm/s noise
+        #    linear: 0.02    #2% noise
\ No newline at end of file
diff --git a/GEMstack/knowledge/defaults/e4_gazebo.yaml b/GEMstack/knowledge/defaults/e4_gazebo.yaml
new file mode 100644
index 00000000..aed9fbec
--- /dev/null
+++ b/GEMstack/knowledge/defaults/e4_gazebo.yaml
@@ -0,0 +1,34 @@
+# ********* Main settings entry point for behavior stack ***********
+
+# Configure settings for the vehicle / vehicle model
+vehicle:  !include ../vehicle/gem_e4_gazebo.yaml
+
+#arguments for algorithm components here
+model_predictive_controller:
+    dt: 0.1
+    lookahead: 20
+control:
+    recovery:
+        brake_amount : 0.5
+        brake_speed : 2.0
+    pure_pursuit:
+        lookahead: 2.0
+        lookahead_scale: 3.0
+        crosstrack_gain: 1.0
+        desired_speed: trajectory
+    longitudinal_control:
+        pid_p: 1.0
+        pid_i: 0.1
+        pid_d: 0.0
+
+#configure the simulator, if using
+simulator:
+    dt: 0.01
+    real_time_multiplier: 1.0    # make the simulator run faster than real time by making this > 1
+    gnss_emulator: 
+        dt: 0.1    #10Hz
+        #position_noise: 0.1  #10cm noise
+        #orientation_noise: 0.04  #2.3 degrees noise
+        #velocity_noise:
+        #    constant: 0.04  #4cm/s noise
+        #    linear: 0.02    #2% noise
\ No newline at end of file
diff --git a/GEMstack/knowledge/vehicle/gem_e2_sensor_environment_gazebo.yaml b/GEMstack/knowledge/vehicle/gem_e2_sensor_environment_gazebo.yaml
index 678ec2c3..25a52bbd 100644
--- a/GEMstack/knowledge/vehicle/gem_e2_sensor_environment_gazebo.yaml
+++ b/GEMstack/knowledge/vehicle/gem_e2_sensor_environment_gazebo.yaml
@@ -1,6 +1,6 @@
 ros_topics:
   top_lidar: /velodyne_points
   front_camera: /front_single_camera/image_raw
-  front_depth: /zed2/zed_node/depth/depth_registered
+  front_depth: /notopic
   gnss: /gps/fix
   
\ No newline at end of file
diff --git a/GEMstack/knowledge/vehicle/gem_e4_gazebo.yaml b/GEMstack/knowledge/vehicle/gem_e4_gazebo.yaml
new file mode 100644
index 00000000..4d953b92
--- /dev/null
+++ b/GEMstack/knowledge/vehicle/gem_e4_gazebo.yaml
@@ -0,0 +1,13 @@
+name: GEM
+version: e4
+max_gear : 1
+num_wiper_settings : 1
+enable_through_joystick : true   #turn this to false to have GEMstack enable control
+max_command_rate : 10.0          #for hardware, max rate of commands to send to vehicle over Pacmod
+#using !include directives helps maintain reuse of common settings
+geometry: !include gem_e2_geometry.yaml
+dynamics: !include gem_e2_dynamics.yaml
+limits: !include gem_e2_slow_limits.yaml
+control_defaults: !include gem_e2_control_defaults.yaml
+calibration: !include ../calibration/gem_e2.yaml
+sensors: !include gem_e2_sensor_environment_gazebo.yaml
diff --git a/launch/gazebo_simulation.yaml b/launch/gazebo_simulation.yaml
index 06c30dbf..484753dd 100644
--- a/launch/gazebo_simulation.yaml
+++ b/launch/gazebo_simulation.yaml
@@ -1,7 +1,7 @@
 description: "Drive the GEM vehicle along a fixed route (currently xyhead_highbay_backlot_p.csv)"
 mode: hardware
 vehicle_interface: gem_hardware.GEMHardwareInterface
-# vehicle: !relative_path ../vehicle/gem_e2_gazebo.yaml
+# !include "../GEMstack/knowledge/defaults/computation_graph.yaml"
 mission_execution: StandardExecutor
 # Recovery behavior after a component failure
 recovery: 
@@ -67,7 +67,6 @@ variants:
                 type: gem_gazebo.GEMDoubleIntegratorSimulationInterface
                 args:
                     scene: !relative_path '../scenes/xyhead_demo.yaml'
-
             drive: 
                 # perception:
                 #     state_estimation : OmniscientStateEstimator
diff --git a/main.py b/main.py
index 64d6afad..d374afd1 100644
--- a/main.py
+++ b/main.py
@@ -21,9 +21,9 @@ if __name__=='__main__':
     else:
         #set the run settings from command line
         run_config = config.load_config_recursive(launch_file)
-        #print(run_config)
         settings.set('run',run_config)
         if settings.get('run.name',None) is None:
+            print("yes")
             settings.set('run.name',launch_file)
 
     from GEMstack.onboard.execution import entrypoint
-- 
2.38.1

