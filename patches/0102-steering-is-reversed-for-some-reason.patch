From bc6ee356d8a94e0305022f5e00a3ceb836ba0e04 Mon Sep 17 00:00:00 2001
From: danielzhuang11 <danielzhuang11@hotmail.com>
Date: Sun, 6 Apr 2025 23:24:06 -0500
Subject: [PATCH 102/150] steering is reversed for some reason

---
 GEMstack/knowledge/routes/gazebo.csv     | 32 ++++++++++++++++++++++++
 GEMstack/onboard/interface/gem_gazebo.py | 16 ++++++------
 launch/gazebo_simulation.yaml            | 12 ++++-----
 3 files changed, 47 insertions(+), 13 deletions(-)
 create mode 100644 GEMstack/knowledge/routes/gazebo.csv

diff --git a/GEMstack/knowledge/routes/gazebo.csv b/GEMstack/knowledge/routes/gazebo.csv
new file mode 100644
index 00000000..ba9be531
--- /dev/null
+++ b/GEMstack/knowledge/routes/gazebo.csv
@@ -0,0 +1,32 @@
+-0.030000000000000027 , 0.0
+-0.1499999999999999 , 0.010000000000001563
+-0.45999999999999996 , 0.010000000000001563
+-0.9300000000000002 , 0.019999999999999574
+-1.7200000000000002 , 0.030000000000001137
+-3.7699999999999996 , 0.05000000000000071
+-4.98 , 0.05999999999999872
+-7.029999999999999 , 0.0799999999999983
+-8.33 , 0.08999999999999986
+-9.84 , 0.10999999999999943
+-12.61 , 0.14000000000000057
+-14.14 , 0.14999999999999858
+-15.510000000000002 , 0.1700000000000017
+-18.48 , 0.21000000000000085
+-19.85 , 0.23000000000000043
+-21.07 , 0.23999999999999844
+-22.54 , 0.26000000000000156
+-24.29 , 0.23000000000000043
+-26.47 , -0.05000000000000071
+-28.84 , -0.8399999999999999
+-31.049999999999997 , -2.34
+-32.37 , -4.870000000000001
+-32.12 , -7.75
+-30.13 , -9.96
+-27.68 , -10.510000000000002
+-25.19 , -9.71
+-23.15 , -7.629999999999999
+-21.85 , -4.699999999999999
+-21.25 , -0.9699999999999989
+-21.86 , 0.7800000000000011
+-21.94 , 1.0700000000000003
+-21.91 , 0.8500000000000014
diff --git a/GEMstack/onboard/interface/gem_gazebo.py b/GEMstack/onboard/interface/gem_gazebo.py
index ac077dbb..0300744b 100644
--- a/GEMstack/onboard/interface/gem_gazebo.py
+++ b/GEMstack/onboard/interface/gem_gazebo.py
@@ -46,6 +46,8 @@ import numpy as np
 
 
 
+
+
 AGENT_DIMENSIONS = {
     'pedestrian' : (0.5,0.5,1.6),
     'bicyclist' : (1.8,0.5,1.6),
@@ -559,7 +561,7 @@ class GEMDoubleIntegratorSimulationInterface(GEMInterface):
         
     def send_command(self, command : GEMVehicleCommand):
 
-        print(command)
+        rospy.loginfo(f"got command: {command}")
         t = self.time()
         if t < self.last_command_time + 1.0/self.max_send_rate:
             #skip command, PACMod can't handle commands this fast
@@ -588,11 +590,11 @@ class GEMDoubleIntegratorSimulationInterface(GEMInterface):
 
 
             return pos_x, pos_y, vel, yaw # note that yaw is in radian
-        #what is phi>>
-        x,y,v,phi = extract_vehicle_info(self.getModelState())
-
         
 
+        _,_,v,phi = extract_vehicle_info(self.getModelState())
+
+
         accelerator_pedal_position = np.clip(command.accelerator_pedal_position,0.0,1.0)
         brake_pedal_position = np.clip(command.brake_pedal_position,0.0,1.0)
         acceleration = pedal_positions_to_acceleration(accelerator_pedal_position,brake_pedal_position,v,0,1)
@@ -613,9 +615,9 @@ class GEMDoubleIntegratorSimulationInterface(GEMInterface):
 
         msg = AckermannDrive()
         msg.acceleration = acceleration
-        msg.speed = float('inf') if acceleration >0 else  float('-inf')  #acceleration * self.dt 
-        msg.steering_angle = phides
-        msg.steering_angle_velocity = steering_angle_rate
+        msg.speed = float('inf') if acceleration >0 else 0  #acceleration * self.dt 
+        msg.steering_angle = -phides
+        msg.steering_angle_velocity = -steering_angle_rate
 
 
         self.ackermann_pub.publish(msg)
diff --git a/launch/gazebo_simulation.yaml b/launch/gazebo_simulation.yaml
index 9983c9c4..1a811ebc 100644
--- a/launch/gazebo_simulation.yaml
+++ b/launch/gazebo_simulation.yaml
@@ -14,7 +14,6 @@ drive:
     perception:
         state_estimation : GNSSStateEstimator
         #agent_detection : object_detection.ObjectDetection
-        perception_normalization : StandardPerceptionNormalizer
     planning:
         # relations_estimation: pedestrian_yield_logic.PedestrianYielder
         # route_planning:
@@ -66,16 +65,17 @@ variants:
             vehicle_interface:
                 type: gem_gazebo.GEMDoubleIntegratorSimulationInterface
                 args:
-                    scene: !relative_path '../scenes/xyhead_demo.yaml'
+                    scene: !relative_path '../scenes/gazebo.yaml'
 
             drive: 
-                # perception:
-                #     state_estimation : OmniscientStateEstimator
-                #     agent_detection : OmniscientAgentDetector
+                perception:
+                    state_estimation : GNSSStateEstimator
+                    perception_normalization : StandardPerceptionNormalizer
+
                 planning:
                     route_planning:
                         type: StaticRoutePlanner
-                        args: [!relative_path '../GEMstack/knowledge/routes/xyhead_highbay_backlot_p.csv']
+                        args: [!relative_path '../GEMstack/knowledge/routes/gazebo.csv']
                     motion_planning:
                         type: RouteToTrajectoryPlanner
                         args: [null]  #desired speed in m/s.  If null, this will keep the route untimed for the trajectory tracker
-- 
2.38.1

