From 455a6b59c2c211b1801254f0912e00baefa671c3 Mon Sep 17 00:00:00 2001
From: Tianshun Gao <tgao13@illinois.edu>
Date: Tue, 15 Apr 2025 15:36:06 -0700
Subject: [PATCH 148/150] tmp

---
 .../sr_viz/threeD/components/Car.js           | 28 +++++++++++++++----
 .../threeD/components/RoadVehicleViz.vue      | 10 +++----
 .../sr_viz/threeD/package-lock.json           | 10 +++++++
 .../visualization/sr_viz/threeD/package.json  |  1 +
 .../sr_viz/threeD/utils/constants.js          |  2 +-
 5 files changed, 39 insertions(+), 12 deletions(-)

diff --git a/GEMstack/onboard/visualization/sr_viz/threeD/components/Car.js b/GEMstack/onboard/visualization/sr_viz/threeD/components/Car.js
index a729d818..6020706f 100644
--- a/GEMstack/onboard/visualization/sr_viz/threeD/components/Car.js
+++ b/GEMstack/onboard/visualization/sr_viz/threeD/components/Car.js
@@ -1,5 +1,6 @@
 import * as THREE from "three";
 import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
+import  URDFLoader  from 'urdf-loader';
 const CAR_X = 19651.6005859375;
 const CAR_Y = 14238.344896316528;
 const CAR_Z = 47565.92169100046;
@@ -20,14 +21,29 @@ export class Car {
         this.steerAngle = 0;
         this.maxSteerAngle = Math.PI / 6;
 
-        const loader = new GLTFLoader();
+        // const loader = new GLTFLoader();
+        // loader.load(
+        //     modelPath,
+        //     (gltf) => {
+        //         this.group = gltf.scene;
+        //         this.group.position.set(this.position.x, this.position.y, this.position.z);
+        //         this.group.scale.set(SCALE_RATE, SCALE_RATE, SCALE_RATE);
+        //         this.group.rotation.y = this.heading;
+
+        //         if (onLoadCallback) onLoadCallback(this);
+        //     },
+        //     undefined,
+        //     (error) => console.error("Error loading car model:", error)
+        // );
+        const loader = new URDFLoader();
         loader.load(
             modelPath,
-            (gltf) => {
-                this.group = gltf.scene;
+            (car) => {
+                this.group = car;
                 this.group.position.set(this.position.x, this.position.y, this.position.z);
-                this.group.scale.set(SCALE_RATE, SCALE_RATE, SCALE_RATE);
-                this.group.rotation.y = this.heading;
+                // this.group.scale.set(SCALE_RATE, SCALE_RATE, SCALE_RATE);
+                this.group.rotation.x = -Math.PI / 2;
+                this.group.rotation.z = -this.heading;
 
                 if (onLoadCallback) onLoadCallback(this);
             },
@@ -77,7 +93,7 @@ export class Car {
         this.heading = Math.atan2(frontWheel.x - backWheel.x, frontWheel.z - backWheel.z);
 
         this.group.position.copy(this.position);
-        this.group.rotation.y = this.heading;
+        this.group.rotation.z = -this.heading;
     }
     updateFromLog(logData) {
         if (!this.group) return;
diff --git a/GEMstack/onboard/visualization/sr_viz/threeD/components/RoadVehicleViz.vue b/GEMstack/onboard/visualization/sr_viz/threeD/components/RoadVehicleViz.vue
index 345a7446..d30159bc 100644
--- a/GEMstack/onboard/visualization/sr_viz/threeD/components/RoadVehicleViz.vue
+++ b/GEMstack/onboard/visualization/sr_viz/threeD/components/RoadVehicleViz.vue
@@ -51,8 +51,8 @@ onMounted(() => {
     window.addEventListener("keypress", handleKeyPress);
 
     initScene();
-    logReader = new LogReader(logJson2, scene, createFuncs);
-    // car = createCar(0, 0, 0, Math.PI / 2);
+    // logReader = new LogReader(logJson3, scene, createFuncs);
+    car = createCar(0, 0, 0, Math.PI / 2);
     // for (let i = 0; i < 4; i++) {
     //     const offset = (i + 1) * 10;
     //     createCar(
@@ -296,9 +296,9 @@ function animate() {
     if (logReader) {
         logReader.update(dt);
     }
-    // if (car) {
-    //     car.update(keys, dt);
-    // }
+    if (car) {
+        car.update(keys, dt);
+    }
     // for (const h of humans) {
     //     h.walk();
     // }
diff --git a/GEMstack/onboard/visualization/sr_viz/threeD/package-lock.json b/GEMstack/onboard/visualization/sr_viz/threeD/package-lock.json
index 7d91a8ba..5b16ff0f 100644
--- a/GEMstack/onboard/visualization/sr_viz/threeD/package-lock.json
+++ b/GEMstack/onboard/visualization/sr_viz/threeD/package-lock.json
@@ -9,6 +9,7 @@
       "dependencies": {
         "nuxt": "^3.16.1",
         "three": "^0.174.0",
+        "urdf-loader": "^0.12.4",
         "vue": "^3.5.13",
         "vue-router": "^4.5.0"
       },
@@ -9573,6 +9574,15 @@
       "integrity": "sha512-MJu7ypHq6QasgF5YRTjqscSzQp/W11zoUk6kvmlH+fmWEs63Y0Eib13hYFwAzagRJcVY8WVnlV+eBDUGMJ5IbA==",
       "license": "MIT"
     },
+    "node_modules/urdf-loader": {
+      "version": "0.12.4",
+      "resolved": "https://registry.npmjs.org/urdf-loader/-/urdf-loader-0.12.4.tgz",
+      "integrity": "sha512-CmBVJmsGDQpWLN3cg9lYkgMGlpbdKqaXDhvG4XXkpADRcYMDWGxHsu0U/1FQcvMq5oke7C65WJoSG2/MyX7HrA==",
+      "license": "Apache-2.0",
+      "peerDependencies": {
+        "three": ">=0.152.0"
+      }
+    },
     "node_modules/uri-js-replace": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/uri-js-replace/-/uri-js-replace-1.0.1.tgz",
diff --git a/GEMstack/onboard/visualization/sr_viz/threeD/package.json b/GEMstack/onboard/visualization/sr_viz/threeD/package.json
index e67efd6c..8f0c2783 100644
--- a/GEMstack/onboard/visualization/sr_viz/threeD/package.json
+++ b/GEMstack/onboard/visualization/sr_viz/threeD/package.json
@@ -12,6 +12,7 @@
   "dependencies": {
     "nuxt": "^3.16.1",
     "three": "^0.174.0",
+    "urdf-loader": "^0.12.4",
     "vue": "^3.5.13",
     "vue-router": "^4.5.0"
   },
diff --git a/GEMstack/onboard/visualization/sr_viz/threeD/utils/constants.js b/GEMstack/onboard/visualization/sr_viz/threeD/utils/constants.js
index 92e76bcf..7c2db2be 100644
--- a/GEMstack/onboard/visualization/sr_viz/threeD/utils/constants.js
+++ b/GEMstack/onboard/visualization/sr_viz/threeD/utils/constants.js
@@ -6,7 +6,7 @@ export const HUMAN_BODY_RATIOS = {
 };
 
 export const HUMAN_TO_CAR_HEIGHT_RATIO = 1.2;
-export const CAR_MODEL_PATH = "/models/Cadillac+CT4+V+2022.glb";
+export const CAR_MODEL_PATH = "/models/model/gem_e4.urdf";
 export const TRAFFIC_LIGHT_MODEL_PATH = "/models/Traffic Light_01.glb";
 export const STREET_LIGHT_MODEL_PATH = "/models/StreetLightPoles.glb";
 export const ENV_MAP_PATH = "/textures/env/";
-- 
2.38.1

